"use client";

import React, { useEffect, useState } from "react";

type EntradaRegistro = {
  par: string;
  modo: string;
  sinal?: string;
  side?: string;
  preco: number;
  alvo: number;
  ganho_pct?: number;
  ganho?: number;
  assert_pct?: number;
  assert?: number;
  data: string;
  hora: string;
};

type EntradaResponse = {
  posicional: EntradaRegistro[];
  ultima_atualizacao?: string;
};

const formatTime = (isoOrTime: string | undefined | null): string => {
  if (!isoOrTime) return "--:--";

  // já está no formato HH:MM
  if (/^\d{2}:\d{2}$/.test(isoOrTime)) {
    return isoOrTime;
  }

  // ISO
  const d = new Date(isoOrTime);
  if (isNaN(d.getTime())) return "--:--";

  return d.toLocaleTimeString("pt-BR", {
    hour: "2-digit",
    minute: "2-digit",
  });
};

const TabelaModo: React.FC<{
  titulo: string;
  registros: EntradaRegistro[];
}> = ({ titulo, registros }) => {
  return (
    <div className="w-full flex justify-center">
      <div className="w-[645px] max-w-[645px]">
        <h2 className="text-center text-orange-400 font-bold mb-2">
          {titulo}
        </h2>

        <div className="overflow-x-hidden">
          <table className="border-collapse text-sm w-[645px]">
            <thead>
              <tr className="text-orange-300 border-b border-slate-800">
                <th
                  className="px-1 py-1 text-left border-r border-slate-800"
                  style={{ width: 70 }}
                >
                  PAR
                </th>
                <th
                  className="px-1 py-1 text-left border-r border-slate-800"
                  style={{ width: 70 }}
                >
                  SIDE
                </th>
                <th
                  className="px-1 py-1 text-right border-r border-slate-800"
                  style={{ width: 90 }}
                >
                  PREÇO
                </th>
                <th
                  className="px-1 py-1 text-right border-r border-slate-800"
                  style={{ width: 90 }}
                >
                  ALVO
                </th>
                <th
                  className="px-1 py-1 text-right border-r border-slate-800"
                  style={{ width: 85 }}
                >
                  GANHO %
                </th>
                <th
                  className="px-1 py-1 text-right border-r border-slate-800"
                  style={{ width: 80 }}
                >
                  ASSERT %
                </th>
                <th
                  className="px-1 py-1 text-center border-r border-slate-800"
                  style={{ width: 90 }}
                >
                  DATA
                </th>
                <th
                  className="px-1 py-1 text-center"
                  style={{ width: 70 }}
                >
                  HORA
                </th>
              </tr>
            </thead>

            <tbody>
              {registros.map((row) => {
                const side = row.sinal || row.side || "NAO_ENTRAR";
                const ganho = Number(row.ganho_pct ?? row.ganho ?? 0);
                const assertPct = Number(row.assert_pct ?? row.assert ?? 0);

                const sideColor =
                  side === "LONG"
                    ? "text-green-400"
                    : side === "SHORT"
                    ? "text-red-400"
                    : "text-slate-200";

                // GANHO sempre positivo no painel (ganho teórico)
                const ganhoColor = "text-green-400";

                const assertColor =
                  assertPct < 65 ? "text-red-400" : "text-emerald-300";

                return (
                  <tr
                    key={`${row.par}-${row.modo}-${row.data}-${row.hora}`}
                    className="border-b border-slate-900"
                  >
                    <td
                      className="px-1 py-1 text-left text-slate-100 border-r border-slate-800"
                      style={{ width: 70 }}
                    >
                      {row.par}
                    </td>

                    <td
                      className={`px-1 py-1 text-left border-r border-slate-800 ${sideColor}`}
                      style={{ width: 70 }}
                    >
                      {side}
                    </td>

                    <td
                      className="px-1 py-1 text-right text-slate-100 border-r border-slate-800"
                      style={{ width: 90 }}
                    >
                      {Number(row.preco || 0).toFixed(3)}
                    </td>

                    <td
                      className="px-1 py-1 text-right text-slate-100 border-r border-slate-800"
                      style={{ width: 90 }}
                    >
                      {Number(row.alvo || 0).toFixed(3)}
                    </td>

                    <td
                      className={`px-1 py-1 text-right border-r border-slate-800 ${ganhoColor}`}
                      style={{ width: 85 }}
                    >
                      {ganho.toFixed(2)}
                    </td>

                    <td
                      className={`px-1 py-1 text-right border-r border-slate-800 ${assertColor}`}
                      style={{ width: 80 }}
                    >
                      {assertPct.toFixed(2)}
                    </td>

                    <td
                      className="px-1 py-1 text-center text-slate-100 border-r border-slate-800"
                      style={{ width: 90 }}
                    >
                      {row.data}
                    </td>

                    <td
                      className="px-1 py-1 text-center text-slate-100"
                      style={{ width: 70 }}
                    >
                      {row.hora}
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

const EntryPanel: React.FC = () => {
  const [data, setData] = useState<EntradaResponse>({
    posicional: [],
  });
  const [lastUpdate, setLastUpdate] = useState<string | null>(null);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const res = await fetch("/api/entrada");
        const json = (await res.json()) as EntradaResponse;
        setData(json);

        // 1ª opção: campo ultima_atualizacao
        let hora: string | null = null;

        if (json.ultima_atualizacao) {
          hora = formatTime(json.ultima_atualizacao);
        } else if (json.posicional && json.posicional.length > 0) {
          // 2ª opção: hora da primeira linha
          hora = formatTime(json.posicional[0].hora);
        }

        setLastUpdate(hora);
      } catch (err) {
        console.error("Erro ao carregar dados de entrada:", err);
      }
    };

    fetchData();
    const id = setInterval(fetchData, 5 * 60 * 1000); // 5 minutos
    return () => clearInterval(id);
  }, []);

  return (
    <div className="w-full flex justify-center text-white">
      <div className="bg-slate-950 rounded-2xl p-4 w-[645px] max-w-[645px]">
        <div className="mb-2">
          {/* Título alinhado à coluna PAR */}
          <div className="flex">
            <h1 className="text-2xl font-bold text-orange-400">
              Painel de Entrada
            </h1>
          </div>

          {/* Texto alinhado sobre a coluna GANHO % */}
          <div
            className="text-sm text-orange-300"
            style={{ marginLeft: 330 }}
          >
            Dados atualizados às:{" "}
            <span className="font-mono">{lastUpdate ?? "--:--"}</span>
          </div>
        </div>

        <TabelaModo
          titulo="POSICIONAL (1D)"
          registros={data.posicional || []}
        />
      </div>
    </div>
  );
};

export default EntryPanel;
